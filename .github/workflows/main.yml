name: publish

on:
  push:
    branches: [ "main" ]

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/ouily1/postgres-ghcr:latest 

jobs:
    publish:
        name: publish image
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v3
        - name: Login
          run: |
            docker login --username ouily1 --password ${{ secrets.GH_PAT }} ghcr.io
        - name: Build and Publish
          run: |
            docker build . --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
    build:
      needs: publish
      runs-on: ubuntu-latest
      steps:
      - name: SSH and Docker Run
        env:
          SSH_PRIV_KEY: ${{ secrets.SSH_PRIV_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
          SSH_KEY_PATH: ${{ github.workspace }}/../private.key
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
         mkdir -p ~/.ssh/
         echo "$SSH_PRIV_KEY" > $SSH_KEY_PATH
         sudo chmod 600 $SSH_KEY_PATH
         echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
         ssh -i $SSH_KEY_PATH root@192.168.1.28 "docker run -d --name test -p 5460:5432 $IMAGE_NAME"

           
